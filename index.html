<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spin Sensory Wheel</title>
  <style>
    body { margin:0; background:#0a0011; overflow:hidden; }
    canvas { display:block; touch-action:none; }

    #muteBtn {
      position:absolute; top:15px; right:15px;
      padding:10px 20px; border:none; border-radius:20px; background:#fff;
      font-size:16px; cursor:pointer; box-shadow:0 0 6px rgba(0,0,0,0.3);
    }
    #volumeSlider { position:absolute; top:65px; right:15px; width:220px; height:30px; }

    #upgradeBtn, #babyLockBtn {
      position:absolute; right:15px; font-size:20px; font-weight:bold; padding:16px 28px;
      border:none; border-radius:35px; color:white; cursor:pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    #upgradeBtn {
      bottom:20px; background:linear-gradient(135deg,#4facfe 0%,#8e2de2 100%);
      box-shadow:0 0 15px rgba(142,45,226,0.6);
    }
    #babyLockBtn {
      bottom:80px; left:15px; right:auto;
      background:linear-gradient(135deg,#43e97b 0%,#38f9d7 100%);
      box-shadow:0 0 15px rgba(56,249,215,0.6); display:none;
    }
    #babyLockInfo {
      display:none; position:absolute; bottom:0; left:0; right:0;
      padding:10px; text-align:center; font-size:16px; color:#fff; background:rgba(0,0,0,0.5);
    }
  </style>
</head>
<body>
  <button id="muteBtn">ðŸ”Š Sound On</button>
  <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.5">
  <button id="upgradeBtn">Upgrade for Baby Lock + No Ads Â· $5 for Life</button>
  <button id="babyLockBtn">Enable Baby Lock</button>
  <div id="babyLockInfo">ðŸ”’ Baby Lock enabled. To exit: Hold Back + Overview buttons.</div>
  <canvas id="wheelCanvas"></canvas>

  <script>
    // Dummy ads/IAP
    function showBanner(){console.log("ads shown");}
    function hideBanner(){console.log("ads hidden");}
    async function initIAP(){return true;}
    async function buyUnlock(){alert("Simulated purchase");}
    async function checkUnlock(){return false;}
    function enableBabyLock(){alert("Baby lock enabled");}

    const canvas=document.getElementById("wheelCanvas"),ctx=canvas.getContext("2d");
    const muteBtn=document.getElementById("muteBtn"),volumeSlider=document.getElementById("volumeSlider");

    let radius=100,audioCtx=null,masterGain=null,soundEnabled=true,volume=0.5;
    let angle=0,spinSpeed=0,friction=0.985,isDragging=false,lastAngle=0,lastTime=0,glowPulseTime=0,lastSlice=null,lastSoundTime=0;

    const colors=["#ff007f","#ff7f00","#ffff00","#00ff00","#00ffff","#0000ff","#8b00ff"];
    const notes=[261.63,293.66,329.63,392.0,440.0,493.88,523.25];

    /* ---------- Bubbles + Ripples ---------- */
    let bubbles=[], ripples=[];
    let tapStartX=0, tapStartY=0, tapStartTime=0;

    function createBubblesFromSpin() {
      const spawnChance = Math.min(Math.abs(spinSpeed) * 0.02, 0.08);
      if (Math.abs(spinSpeed) > 0.01 && Math.random() < spawnChance) {
        const angleOffset = angle + (Math.random()*0.5 - 0.25);
        const spawnRadius = radius + 12;
        const bx = canvas.width/2 + Math.cos(angleOffset)*spawnRadius;
        const by = canvas.height/2 + Math.sin(angleOffset)*spawnRadius;
        const size = 70 + Math.random()*30;
        const speed = 0.3 + Math.random()*0.6;
        const vx = Math.cos(angleOffset)*speed, vy = Math.sin(angleOffset)*speed;
        bubbles.push({ x:bx, y:by, r:size, vx, vy, popped:false });
      }
    }

    function drawBubbles(){
      bubbles.forEach((b,i)=>{
        if (b.popped) return;
        const g=ctx.createRadialGradient(b.x,b.y,b.r*0.6,b.x,b.y,b.r);
        g.addColorStop(0,"rgba(255,255,255,0.05)");
        g.addColorStop(0.7,"rgba(255,255,255,0.1)");
        g.addColorStop(1,"rgba(255,255,255,0.25)");
        ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,2*Math.PI);
        ctx.fillStyle=g; ctx.fill();

        const sheen=ctx.createLinearGradient(b.x-b.r,b.y-b.r,b.x+b.r,b.y+b.r);
        sheen.addColorStop(0,"rgba(255,0,255,0.22)");
        sheen.addColorStop(0.25,"rgba(0,255,255,0.22)");
        sheen.addColorStop(0.5,"rgba(0,255,0,0.18)");
        sheen.addColorStop(0.75,"rgba(255,255,0,0.22)");
        sheen.addColorStop(1,"rgba(255,0,0,0.22)");
        ctx.strokeStyle=sheen; ctx.lineWidth=2; ctx.stroke();

        ctx.beginPath();
        ctx.arc(b.x-b.r*0.3,b.y-b.r*0.3,b.r*0.2,0,2*Math.PI);
        ctx.fillStyle="rgba(255,255,255,0.35)"; ctx.fill();

        b.x+=b.vx; b.y+=b.vy;
        if(b.x+b.r<0||b.x-b.r>canvas.width||b.y+b.r<0||b.y-b.r>canvas.height){
          bubbles.splice(i,1);
        }
      });
    }

    function drawRipples(){
      ripples.forEach((r,i)=>{
        ctx.beginPath(); ctx.arc(r.x,r.y,r.radius,0,2*Math.PI);
        ctx.strokeStyle=`rgba(255,255,255,${r.alpha})`;
        ctx.lineWidth=3; ctx.stroke();
        r.radius+=2; r.alpha-=0.03;
        if(r.alpha<=0) ripples.splice(i,1);
      });
    }

    /* ---------- Randomized Watery Drip ---------- */
    function playBubblePop(x,y){
      if (!soundEnabled) return;
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        masterGain = audioCtx.createGain();
        masterGain.gain.value = volume;
        masterGain.connect(audioCtx.destination);
      }

      const now = audioCtx.currentTime;

      // randomized drip values
      const startFreq = 500 + Math.random()*300;   // Hz
      const endFreq = 150 + Math.random()*150;     // Hz
      const decay = 0.2 + Math.random()*0.1;       // seconds
      const echoDelay = 0.1 + Math.random()*0.05;  // seconds
      const echoVol = 0.05 + Math.random()*0.1;

      // droplet sine sweep
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = "sine";
      osc.frequency.setValueAtTime(startFreq, now);
      osc.frequency.exponentialRampToValueAtTime(endFreq, now + decay);

      gain.gain.setValueAtTime(0.3, now);
      gain.gain.exponentialRampToValueAtTime(0.001, now + decay);

      // subtle randomized echo
      const delay = audioCtx.createDelay();
      delay.delayTime.value = echoDelay;
      const echoGain = audioCtx.createGain();
      echoGain.gain.value = echoVol;

      osc.connect(gain);
      gain.connect(masterGain);
      gain.connect(delay);
      delay.connect(echoGain);
      echoGain.connect(masterGain);

      osc.start(now);
      osc.stop(now + decay);

      ripples.push({ x, y, radius:20, alpha:0.8 });
    }

    /* ---------- Wheel ---------- */
    function resizeCanvas(){
      canvas.width = window.innerWidth || 600;
      canvas.height= window.innerHeight || 600;
      radius = Math.min(canvas.width,canvas.height)*0.45;
    }
    window.addEventListener("resize", resizeCanvas);

    function getPointerAngle(x,y){
      const r=canvas.getBoundingClientRect();
      const cx=r.left+canvas.width/2, cy=r.top+canvas.height/2;
      return Math.atan2(y-cy, x-cx);
    }

    function getAverageAngle(touches){
      let sumX=0, sumY=0;
      const rect=canvas.getBoundingClientRect();
      for (let t of touches){
        const x=(t.clientX||t.pageX)-rect.left;
        const y=(t.clientY||t.pageY)-rect.top;
        sumX+=x; sumY+=y;
      }
      const avgX=sumX/touches.length, avgY=sumY/touches.length;
      return getPointerAngle(avgX, avgY);
    }

    function drawWheel(){
      ctx.save(); ctx.translate(canvas.width/2, canvas.height/2); ctx.rotate(angle);
      glowPulseTime+=0.02; const pulse=50+Math.sin(glowPulseTime)*10;
      ctx.beginPath(); ctx.arc(0,0, radius+12, 0, 2*Math.PI);
      ctx.strokeStyle="white"; ctx.lineWidth=4; ctx.shadowColor="white"; ctx.shadowBlur=pulse*1.5; ctx.stroke();
      for(let i=0;i<colors.length;i++){
        ctx.beginPath(); ctx.moveTo(0,0);
        ctx.arc(0,0, radius, (i*2*Math.PI)/colors.length, ((i+1)*2*Math.PI)/colors.length);
        ctx.closePath(); ctx.fillStyle=colors[i];
        ctx.shadowColor=colors[i]; ctx.shadowBlur=pulse; ctx.fill();
      }
      ctx.restore();
    }

    function animate(){
      if(!isDragging){ angle += spinSpeed; spinSpeed *= friction; }
      createBubblesFromSpin();

      const normalized=((angle%(2*Math.PI))+2*Math.PI)%(2*Math.PI);
      const currentSlice=Math.floor((normalized/(2*Math.PI))*colors.length);
      const now=performance.now();
      if(currentSlice!==lastSlice && Math.abs(spinSpeed)>0.05 && now-lastSoundTime>100){
        playSliceTone(currentSlice, spinSpeed>0?"cw":"ccw");
        lastSlice=currentSlice; lastSoundTime=now;
      }

      ctx.clearRect(0,0,canvas.width,canvas.height);
      drawBubbles(); drawRipples(); drawWheel();
      requestAnimationFrame(animate);
    }

    function ensureAudio(){
      if(!audioCtx){
        audioCtx=new (window.AudioContext||window.webkitAudioContext)();
        masterGain=audioCtx.createGain();
        masterGain.gain.value=volume;
        masterGain.connect(audioCtx.destination);
      }
    }
    function playSliceTone(sliceIndex,dir){
      if(!soundEnabled) return;
      ensureAudio();
      const freq=(dir==="cw"?notes[sliceIndex%notes.length]:notes[sliceIndex%notes.length]/2);
      const osc=audioCtx.createOscillator(), gain=audioCtx.createGain();
      osc.type=(dir==="cw"?"sine":"triangle");
      osc.frequency.setValueAtTime(freq,audioCtx.currentTime);
      gain.gain.setValueAtTime(0,audioCtx.currentTime);
      gain.gain.linearRampToValueAtTime(0.15,audioCtx.currentTime+0.02);
      gain.gain.linearRampToValueAtTime(0.15,audioCtx.currentTime+0.2);
      gain.gain.linearRampToValueAtTime(0,audioCtx.currentTime+0.25);
      osc.connect(gain); gain.connect(masterGain);
      osc.start(); osc.stop(audioCtx.currentTime+0.25);
    }

    // --- Pointer logic ---
    let activeTouches=[];

    function pointerDown(e){
      const rect=canvas.getBoundingClientRect();
      const x=(e.clientX||e.touches[0].clientX)-rect.left;
      const y=(e.clientY||e.touches[0].clientY)-rect.top;
      const dx=x-canvas.width/2, dy=y-canvas.height/2;

      if (Math.hypot(dx,dy) <= radius) {
        isDragging=true;
        activeTouches=e.touches?[...e.touches]:[e];
        lastAngle=getAverageAngle(activeTouches);
        lastTime=Date.now(); spinSpeed=0;
      }

      tapStartX=x; tapStartY=y; tapStartTime=Date.now();
    }

    function pointerMove(e){
      if(!isDragging) return;
      activeTouches=e.touches?[...e.touches]:[e];
      const a=getAverageAngle(activeTouches);
      const now=Date.now();
      const d=a-lastAngle;
      angle+=d; spinSpeed=d/((now-lastTime)/1000);
      lastAngle=a; lastTime=now;
    }

    function pointerUp(e){
      if(e.touches && e.touches.length>0){
        activeTouches=[...e.touches];
        lastAngle=getAverageAngle(activeTouches);
      } else {
        if(isDragging){
          isDragging=false;
          activeTouches=[];
        } else {
          const rect=canvas.getBoundingClientRect();
          const x=(e.clientX||tapStartX)-rect.left;
          const y=(e.clientY||tapStartY)-rect.top;
          const dx=x-tapStartX, dy=y-tapStartY;
          const dist=Math.hypot(dx,dy);
          const time=Date.now()-tapStartTime;

          if(dist < 15 && time < 250){
            bubbles.forEach(b=>{
              if(!b.popped){
                const d=Math.hypot(b.x-x,b.y-y);
                if(d<b.r){ b.popped=true; playBubblePop(b.x,b.y); }
              }
            });
          }
        }
      }
    }

    // --- UI controls ---
    muteBtn.onclick=()=>{
      soundEnabled=!soundEnabled;
      muteBtn.textContent=soundEnabled?"ðŸ”Š Sound On":"ðŸ”‡ Sound Off";
    };
    volumeSlider.oninput=e=>{
      volume=parseFloat(e.target.value);
      if(masterGain){ masterGain.gain.value=volume; }
    };

    canvas.addEventListener("pointerdown",pointerDown);
    canvas.addEventListener("pointermove",pointerMove);
    canvas.addEventListener("pointerup",pointerUp);
    canvas.addEventListener("pointercancel",pointerUp);

    window.onload=async()=>{
      resizeCanvas(); animate();
      await initIAP();
      const unlocked=await checkUnlock();
      if(!unlocked){
        showBanner();
        document.getElementById("upgradeBtn").onclick=buyUnlock;
      } else {
        document.getElementById("upgradeBtn").style.display="none";
        document.getElementById("babyLockBtn").style.display="block";
        document.getElementById("babyLockBtn").onclick=enableBabyLock;
      }
    };
  </script>
</body>
</html>
