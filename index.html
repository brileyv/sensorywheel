<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spin Sensory Wheel</title>
  <style>
    body { margin:0; background:#0a0011; overflow:hidden; }
    canvas { display:block; touch-action:none; }

    #muteBtn {
      position:absolute; top:15px; right:15px;
      padding:10px 20px; border:none; border-radius:20px; background:#fff;
      font-size:16px; cursor:pointer; box-shadow:0 0 6px rgba(0,0,0,0.3);
    }
    #volumeSlider { position:absolute; top:65px; right:15px; width:220px; height:30px; }

    #upgradeBtn, #babyLockBtn {
      position:absolute; right:15px; font-size:20px; font-weight:bold; padding:16px 28px;
      border:none; border-radius:35px; color:white; cursor:pointer;
    }
    #upgradeBtn {
      bottom:20px; background:linear-gradient(135deg,#4facfe 0%,#8e2de2 100%);
    }
    #babyLockBtn {
      bottom:80px; left:15px; right:auto;
      background:linear-gradient(135deg,#43e97b 0%,#38f9d7 100%);
      display:none;
    }
    #babyLockInfo {
      display:none; position:absolute; bottom:0; left:0; right:0;
      padding:10px; text-align:center; font-size:16px; color:#fff; background:rgba(0,0,0,0.5);
    }
  </style>
</head>
<body>
  <button id="muteBtn">ðŸ”Š Sound On</button>
  <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.5">
  <button id="upgradeBtn">Upgrade for Baby Lock + No Ads Â· $5 for Life</button>
  <button id="babyLockBtn">Enable Baby Lock</button>
  <div id="babyLockInfo">ðŸ”’ Baby Lock enabled. To exit: Hold Back + Overview buttons.</div>
  <canvas id="wheelCanvas"></canvas>

  <script>
    // Dummy ads/IAP
    function showBanner(){console.log("ads shown");}
    function hideBanner(){console.log("ads hidden");}
    async function initIAP(){return true;}
    async function buyUnlock(){alert("Simulated purchase");}
    async function checkUnlock(){return false;}
    function enableBabyLock(){alert("Baby lock enabled");}

    const canvas=document.getElementById("wheelCanvas"),ctx=canvas.getContext("2d");
    const muteBtn=document.getElementById("muteBtn"),volumeSlider=document.getElementById("volumeSlider");

    let radius=100,audioCtx=null,masterGain=null,soundEnabled=true,volume=0.5;
    let angle=0,spinSpeed=0,friction=0.985,isDragging=false,lastAngle=0,lastTime=0,glowPulseTime=0,lastSlice=null,lastSoundTime=0;

    const colors=["#ff007f","#ff7f00","#ffff00","#00ff00","#00ffff","#0000ff","#8b00ff"];

    /* ---------- Music scale ---------- */
    const scale = [261.63, 293.66, 329.63, 349.23, 392.0, 440.0, 493.88, 523.25];
    let wheelNoteIndex = 0;
    let bubbleNoteIndex = 0;

    /* ---------- Bubbles ---------- */
    let bubbles=[], ripples=[];
    const bubbleCount = 35;
    const minSize = 70, maxSize = 110;
    const minSpeed = 0.4, maxSpeed = 1.2;

    function newBubble() {
      let safe = false;
      let bubble;
      let attempts = 0;
      while (!safe && attempts < 100) {
        bubble = {
          x: Math.random() * (canvas.width - maxSize*2) + maxSize,
          y: -Math.random() * canvas.height,
          r: minSize + Math.random() * (maxSize - minSize),
          vy: minSpeed + Math.random() * (maxSpeed - minSpeed),
          drift: (Math.random() * 0.6 - 0.3)
        };
        safe = true;
        for (let other of bubbles) {
          const dist = Math.hypot(bubble.x - other.x, bubble.y - other.y);
          if (dist < bubble.r + other.r + 25) {
            safe = false;
            break;
          }
        }
        attempts++;
      }
      return bubble;
    }

    function initBubbles() {
      bubbles=[];
      let spawnInterval = setInterval(()=>{
        if (bubbles.length < bubbleCount) {
          bubbles.push(newBubble());
        } else {
          clearInterval(spawnInterval);
        }
      }, 600);
    }

    function drawBubbles(){
      bubbles.forEach((b,i)=>{
        const g = ctx.createRadialGradient(b.x,b.y,b.r*0.4,b.x,b.y,b.r);
        g.addColorStop(0,"rgba(255,255,255,0.15)");
        g.addColorStop(1,"rgba(200,255,255,0.25)");
        ctx.beginPath();
        ctx.arc(b.x,b.y,b.r,0,2*Math.PI);
        ctx.fillStyle=g;
        ctx.fill();

        // movement with gentle wiggle
        b.y += b.vy;
        b.x += b.drift + Math.sin((Date.now()/500) + b.y/50) * 0.5;

        if (b.y - b.r > canvas.height) {
          bubbles[i] = newBubble();
          bubbles[i].y = -b.r;
        }
      });
    }

    function drawRipples(){
      ripples.forEach((r,i)=>{
        ctx.beginPath(); ctx.arc(r.x,r.y,r.radius,0,2*Math.PI);
        ctx.strokeStyle=`rgba(255,255,255,${r.alpha})`;
        ctx.lineWidth=3; ctx.stroke();
        r.radius+=2; r.alpha-=0.03;
        if(r.alpha<=0) ripples.splice(i,1);
      });
    }

    /* ---------- Audio ---------- */
    function ensureAudio(){
      if(!audioCtx){
        audioCtx=new (window.AudioContext||window.webkitAudioContext)();
        masterGain=audioCtx.createGain();
        masterGain.gain.value=volume;
        masterGain.connect(audioCtx.destination);
      }
    }

    function playNote(freq, type="sine"){
      if(!soundEnabled) return;
      ensureAudio();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = type;
      osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
      gain.gain.setValueAtTime(0.25, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
      osc.connect(gain);
      gain.connect(masterGain);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.5);
    }

    function playBubblePop(x,y){
      const freq = scale[bubbleNoteIndex];
      ensureAudio();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = "sine";
      osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
      gain.gain.setValueAtTime(0.25, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
      osc.connect(gain);
      gain.connect(masterGain);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.5);
      ripples.push({ x, y, radius:20, alpha:0.8 });
      bubbleNoteIndex = (bubbleNoteIndex + 1) % scale.length;
    }

    /* ---------- Wheel ---------- */
    function resizeCanvas(){
      canvas.width = window.innerWidth || 600;
      canvas.height= window.innerHeight || 600;
      radius = Math.min(canvas.width,canvas.height)*0.45;
      initBubbles();
    }
    window.addEventListener("resize", resizeCanvas);

    function drawWheel(){
      ctx.save(); ctx.translate(canvas.width/2, canvas.height/2); ctx.rotate(angle);
      glowPulseTime+=0.02; const pulse=50+Math.sin(glowPulseTime)*10;
      ctx.beginPath(); ctx.arc(0,0, radius+12, 0, 2*Math.PI);
      ctx.strokeStyle="white"; ctx.lineWidth=4; ctx.shadowColor="white"; ctx.shadowBlur=pulse*1.5; ctx.stroke();
      for(let i=0;i<colors.length;i++){
        ctx.beginPath(); ctx.moveTo(0,0);
        ctx.arc(0,0, radius, (i*2*Math.PI)/colors.length, ((i+1)*2*Math.PI)/colors.length);
        ctx.closePath(); ctx.fillStyle=colors[i];
        ctx.shadowColor=colors[i]; ctx.shadowBlur=pulse; ctx.fill();
      }
      ctx.restore();
    }

    function animate(){
      if(!isDragging){ angle += spinSpeed; spinSpeed *= friction; }
      const normalized=((angle%(2*Math.PI))+2*Math.PI)%(2*Math.PI);
      const currentSlice=Math.floor((normalized/(2*Math.PI))*colors.length);
      const now=performance.now();
      if(currentSlice!==lastSlice && Math.abs(spinSpeed)>0.05 && now-lastSoundTime>120){
        if(spinSpeed > 0){
          playNote(scale[wheelNoteIndex],"sine");
          wheelNoteIndex = (wheelNoteIndex + 1) % scale.length;
        } else {
          wheelNoteIndex = (wheelNoteIndex - 1 + scale.length) % scale.length;
          playNote(scale[wheelNoteIndex],"triangle");
        }
        lastSlice=currentSlice;
        lastSoundTime=now;
      }
      ctx.clearRect(0,0,canvas.width,canvas.height);
      drawBubbles(); drawRipples(); drawWheel();
      requestAnimationFrame(animate);
    }

    /* ---------- Wheel controls ---------- */
    let activeFingerId = null;

    function getPointerAngle(x,y){
      const r=canvas.getBoundingClientRect();
      const cx=r.left+canvas.width/2, cy=r.top+canvas.height/2;
      return Math.atan2(y-cy, x-cx);
    }

    function pointerDown(e){
      const rect=canvas.getBoundingClientRect();
      const x=(e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
      const y=(e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;

      const dx = x - canvas.width/2;
      const dy = y - canvas.height/2;

      if (Math.hypot(dx,dy) <= radius && activeFingerId === null) {
        isDragging = true;
        activeFingerId = e.pointerId || (e.changedTouches && e.changedTouches[0].identifier);
        lastAngle = getPointerAngle(x,y);
        lastTime = Date.now();
        spinSpeed = 0;
      } 

      // Always check bubbles
      bubbles.forEach((b,i)=>{
        const d=Math.hypot(b.x-x,b.y-y);
        if(d<b.r){
          playBubblePop(b.x,b.y);
          bubbles[i] = newBubble();
          bubbles[i].y = -b.r;
        }
      });
    }

    function pointerMove(e){
      if(!isDragging) return;
      if (e.pointerId && e.pointerId !== activeFingerId) return;
      if (e.changedTouches && e.changedTouches[0].identifier !== activeFingerId) return;
      const rect=canvas.getBoundingClientRect();
      const x=(e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
      const y=(e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;
      const a=getPointerAngle(x,y);
      const now=Date.now();
      const d=a-lastAngle;
      angle+=d;
      spinSpeed=d/((now-lastTime)/1000);
      lastAngle=a;
      lastTime=now;
    }

    function pointerUp(e){
      if (e.pointerId && e.pointerId === activeFingerId) {
        isDragging=false; activeFingerId=null;
      }
      if (e.changedTouches && e.changedTouches[0].identifier === activeFingerId) {
        isDragging=false; activeFingerId=null;
      }
    }

    /* ---------- UI controls ---------- */
    muteBtn.onclick=()=>{
      soundEnabled=!soundEnabled;
      muteBtn.textContent=soundEnabled?"ðŸ”Š Sound On":"ðŸ”‡ Sound Off";
    };
    volumeSlider.oninput=e=>{
      volume=parseFloat(e.target.value);
      if(masterGain){ masterGain.gain.value=volume; }
    };

    canvas.addEventListener("pointerdown",pointerDown);
    canvas.addEventListener("pointermove",pointerMove);
    canvas.addEventListener("pointerup",pointerUp);
    canvas.addEventListener("pointercancel",pointerUp);

    /* ---------- Start ---------- */
    window.onload=async()=>{
      resizeCanvas(); animate(); initBubbles();
      await initIAP();
      const unlocked=await checkUnlock();
      if(!unlocked){
        showBanner();
        document.getElementById("upgradeBtn").onclick=buyUnlock;
      } else {
        document.getElementById("upgradeBtn").style.display="none";
        document.getElementById("babyLockBtn").style.display="block";
        document.getElementById("babyLockBtn").onclick=enableBabyLock;
      }
    };
  </script>
</body>
</html>
