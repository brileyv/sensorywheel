<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sensory Wheel</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #0b0013;
      font-family: sans-serif;
      color: white;
      text-align: center;
    }

    canvas {
      display: block;
    }

    /* Bottom controls */
    #controls {
      position: absolute;
      bottom: 60px;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      z-index: 20;
    }

    #upgradeButton {
      background: linear-gradient(90deg, #a200ff, #ff00aa);
      border: none;
      border-radius: 20px;
      padding: 12px 24px;
      font-size: 16px;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    #instructions {
      font-size: 12px;
      opacity: 0.8;
    }

    /* Volume controls */
    #volumeBtn {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 28px;
      cursor: pointer;
      z-index: 30;
    }

    #volumePopup {
      position: absolute;
      top: 70px;
      right: 20px;
      background: rgba(0,0,0,0.85);
      padding: 10px;
      border-radius: 8px;
      display: none;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
      z-index: 40;
    }

    #volumeSlider {
      width: 120px;
    }

    #closePopup {
      align-self: flex-end;
      background: crimson;
      border: none;
      border-radius: 6px;
      color: white;
      padding: 2px 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <canvas id="wheelCanvas"></canvas>

  <!-- Volume controls -->
  <div id="volumeBtn">ðŸ”Š</div>
  <div id="volumePopup">
    <button id="closePopup">X</button>
    <button id="muteToggle">Mute</button>
    <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.5">
  </div>

  <!-- Upgrade controls -->
  <div id="controls">
    <button id="upgradeButton">Upgrade for Baby Lock + No Ads Â· $5 for Life</button>
    <div id="instructions">
      Hold volume button 3s for settings Â· Hold both top corners 3s to exit Baby Lock
    </div>
  </div>

  <script>
    const canvas = document.getElementById('wheelCanvas');
    const ctx = canvas.getContext('2d');
    let width = window.innerWidth, height = window.innerHeight;
    canvas.width = width; canvas.height = height;

    // Wheel
    let wheelRadius = Math.min(width, height) / 2.8;
    let wheelX = width / 2, wheelY = height / 2;
    let rotation = 0, lastAngle = 0, isDragging = false;
    let spinDir = 1;

    const colors = ["red","orange","yellow","lime","cyan","blue","violet"];

    // Bubbles
    class Bubble {
      constructor() { this.reset(); }
      reset() {
        this.x = Math.random()*width;
        this.y = -50;
        this.size = 35+Math.random()*35;
        this.speed = 0.5+Math.random()*1.2;
      }
      update() { this.y += this.speed; if(this.y > height+this.size) this.reset(); }
      draw() {
        const grd = ctx.createRadialGradient(this.x-this.size/3,this.y-this.size/3,this.size*0.2,this.x,this.y,this.size);
        grd.addColorStop(0,"rgba(255,255,255,0.9)");
        grd.addColorStop(0.3,"rgba(173,216,230,0.4)");
        grd.addColorStop(0.6,"rgba(255,105,180,0.3)");
        grd.addColorStop(1,"rgba(0,255,255,0.15)");
        ctx.fillStyle = grd;
        ctx.beginPath();
        ctx.arc(this.x,this.y,this.size,0,Math.PI*2);
        ctx.fill();
        ctx.strokeStyle="rgba(255,255,255,0.4)";
        ctx.stroke();
      }
    }
    const bubbles = Array.from({length: 18},()=>new Bubble());

    // Audio
    const AudioContext = window.AudioContext||window.webkitAudioContext;
    const audioCtx = new AudioContext();
    const gainNode = audioCtx.createGain();
    gainNode.connect(audioCtx.destination);
    gainNode.gain.value = 0.5;
    let soundOn = true;
    const scale = [261.63,293.66,329.63,349.23,392,440,493.88,523.25];
    let noteIndex = 0;

    function playNote(idx) {
      if(!soundOn) return;
      const osc = audioCtx.createOscillator();
      osc.type="sine";
      osc.frequency.value=scale[idx];
      osc.connect(gainNode);
      osc.start();
      osc.stop(audioCtx.currentTime+0.25);
    }

    // Drawing
    function drawWheel(){
      ctx.save();
      ctx.translate(wheelX,wheelY);
      ctx.rotate(rotation);
      const slice=2*Math.PI/colors.length;
      for(let i=0;i<colors.length;i++){
        ctx.beginPath();
        ctx.moveTo(0,0);
        ctx.arc(0,0,wheelRadius,i*slice,(i+1)*slice);
        ctx.closePath();
        ctx.fillStyle=colors[i];
        ctx.fill();
      }
      ctx.restore();
      // Glow
      ctx.beginPath();
      ctx.arc(wheelX,wheelY,wheelRadius,0,Math.PI*2);
      ctx.lineWidth=6;
      ctx.strokeStyle="white";
      ctx.shadowBlur=30; ctx.shadowColor="white";
      ctx.stroke(); ctx.shadowBlur=0;
    }

    function loop(){
      ctx.clearRect(0,0,width,height);
      bubbles.forEach(b=>{b.update();b.draw();});
      drawWheel();
      requestAnimationFrame(loop);
    }
    loop();

    // Spin logic
    canvas.addEventListener("touchstart",e=>{
      const t=e.touches[0];
      lastAngle=Math.atan2(t.clientY-wheelY,t.clientX-wheelX);
      isDragging=true;
    });
    canvas.addEventListener("touchmove",e=>{
      if(!isDragging) return;
      const t=e.touches[0];
      const angle=Math.atan2(t.clientY-wheelY,t.clientX-wheelX);
      const delta=angle-lastAngle;
      rotation+=delta; spinDir=delta>0?1:-1; lastAngle=angle;
      const step=Math.floor(((rotation%(2*Math.PI))+2*Math.PI)%(2*Math.PI)/(2*Math.PI/scale.length));
      if(step>=0&&step<scale.length){
        const idx=spinDir>0?step:scale.length-1-step;
        playNote(idx);
      }
    });
    canvas.addEventListener("touchend",()=>isDragging=false);

    // Bubbles pop sound
    canvas.addEventListener("click",e=>{
      const x=e.clientX,y=e.clientY;
      for(let b of bubbles){
        const dx=x-b.x,dy=y-b.y;
        if(dx*dx+dy*dy<b.size*b.size){
          b.reset();
          playNote(noteIndex);
          noteIndex=(noteIndex+1)%scale.length;
          break;
        }
      }
    });

    // Volume controls
    const volumeBtn=document.getElementById("volumeBtn");
    const volumePopup=document.getElementById("volumePopup");
    const muteToggle=document.getElementById("muteToggle");
    const volumeSlider=document.getElementById("volumeSlider");
    const closePopup=document.getElementById("closePopup");
    let holdTimer;
    volumeBtn.addEventListener("touchstart",()=>{
      holdTimer=setTimeout(()=>{
        volumePopup.style.display="flex";
        setTimeout(()=>{volumePopup.style.display="none";},5000);
      },3000);
    });
    volumeBtn.addEventListener("touchend",()=>clearTimeout(holdTimer));
    muteToggle.onclick=()=>{
      soundOn=!soundOn;
      muteToggle.textContent=soundOn?"Mute":"Unmute";
    };
    volumeSlider.oninput=e=>{gainNode.gain.value=parseFloat(e.target.value);};
    closePopup.onclick=()=>{volumePopup.style.display="none";};

    // Upgrade
    document.getElementById("upgradeButton").onclick=()=>{
      alert("âœ… You're now ad-free, and Baby Lock is enabled!");
    };

    // Resize
    window.addEventListener("resize",()=>{
      width=window.innerWidth;height=window.innerHeight;
      canvas.width=width;canvas.height=height;
      wheelRadius=Math.min(width,height)/2.8;
      wheelX=width/2;wheelY=height/2;
    });
  </script>
</body>
</html>
